<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>curl_cffi.requests.session &mdash; stockdex  documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/sphinx_highlight.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            stockdex
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../readme.html">Project description</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">stockdex</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">stockdex</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">curl_cffi.requests.session</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for curl_cffi.requests.session</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">http.cookies</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">queue</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">threading</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">warnings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">concurrent.futures</span><span class="w"> </span><span class="kn">import</span> <span class="n">ThreadPoolExecutor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">contextlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">asynccontextmanager</span><span class="p">,</span> <span class="n">contextmanager</span><span class="p">,</span> <span class="n">suppress</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">io</span><span class="w"> </span><span class="kn">import</span> <span class="n">BytesIO</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">TYPE_CHECKING</span><span class="p">,</span>
    <span class="n">Callable</span><span class="p">,</span>
    <span class="n">Generic</span><span class="p">,</span>
    <span class="n">Literal</span><span class="p">,</span>
    <span class="n">Optional</span><span class="p">,</span>
    <span class="n">TypedDict</span><span class="p">,</span>
    <span class="n">TypeVar</span><span class="p">,</span>
    <span class="n">Union</span><span class="p">,</span>
    <span class="n">cast</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">urllib.parse</span><span class="w"> </span><span class="kn">import</span> <span class="n">urlparse</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">..aio</span><span class="w"> </span><span class="kn">import</span> <span class="n">AsyncCurl</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..const</span><span class="w"> </span><span class="kn">import</span> <span class="n">CurlHttpVersion</span><span class="p">,</span> <span class="n">CurlInfo</span><span class="p">,</span> <span class="n">CurlOpt</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..curl</span><span class="w"> </span><span class="kn">import</span> <span class="n">Curl</span><span class="p">,</span> <span class="n">CurlError</span><span class="p">,</span> <span class="n">CurlMime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">..utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">CurlCffiWarning</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.cookies</span><span class="w"> </span><span class="kn">import</span> <span class="n">Cookies</span><span class="p">,</span> <span class="n">CookieTypes</span><span class="p">,</span> <span class="n">CurlMorsel</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">RequestException</span><span class="p">,</span> <span class="n">SessionClosed</span><span class="p">,</span> <span class="n">code2error</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.headers</span><span class="w"> </span><span class="kn">import</span> <span class="n">Headers</span><span class="p">,</span> <span class="n">HeaderTypes</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.impersonate</span><span class="w"> </span><span class="kn">import</span> <span class="n">BrowserTypeLiteral</span><span class="p">,</span> <span class="n">ExtraFingerprints</span><span class="p">,</span> <span class="n">ExtraFpDict</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">STREAM_END</span><span class="p">,</span> <span class="n">Response</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">not_set</span><span class="p">,</span> <span class="n">set_curl_options</span><span class="p">,</span> <span class="n">HttpVersionLiteral</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.websockets</span><span class="w"> </span><span class="kn">import</span> <span class="n">AsyncWebSocket</span><span class="p">,</span> <span class="n">WebSocket</span>

<span class="k">with</span> <span class="n">suppress</span><span class="p">(</span><span class="ne">ImportError</span><span class="p">):</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">gevent</span>

<span class="k">with</span> <span class="n">suppress</span><span class="p">(</span><span class="ne">ImportError</span><span class="p">):</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">eventlet.tpool</span>

<span class="c1"># Added in 3.13: https://docs.python.org/3/library/typing.html#typing.TypeVar.__default__</span>
<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">13</span><span class="p">):</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;R&quot;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="n">Response</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">Response</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">R</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;R&quot;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="n">Response</span><span class="p">)</span>

<span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">typing_extensions</span><span class="w"> </span><span class="kn">import</span> <span class="n">Unpack</span>

    <span class="k">class</span><span class="w"> </span><span class="nc">ProxySpec</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="nb">all</span><span class="p">:</span> <span class="nb">str</span>
        <span class="n">http</span><span class="p">:</span> <span class="nb">str</span>
        <span class="n">https</span><span class="p">:</span> <span class="nb">str</span>
        <span class="n">ws</span><span class="p">:</span> <span class="nb">str</span>
        <span class="n">wss</span><span class="p">:</span> <span class="nb">str</span>

    <span class="k">class</span><span class="w"> </span><span class="nc">BaseSessionParams</span><span class="p">(</span><span class="n">Generic</span><span class="p">[</span><span class="n">R</span><span class="p">],</span> <span class="n">TypedDict</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">HeaderTypes</span><span class="p">]</span>
        <span class="n">cookies</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CookieTypes</span><span class="p">]</span>
        <span class="n">auth</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span>
        <span class="n">proxies</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ProxySpec</span><span class="p">]</span>
        <span class="n">proxy</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
        <span class="n">proxy_auth</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span>
        <span class="n">base_url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
        <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span>
        <span class="n">verify</span><span class="p">:</span> <span class="nb">bool</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span>
        <span class="n">trust_env</span><span class="p">:</span> <span class="nb">bool</span>
        <span class="n">allow_redirects</span><span class="p">:</span> <span class="nb">bool</span>
        <span class="n">max_redirects</span><span class="p">:</span> <span class="nb">int</span>
        <span class="n">impersonate</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BrowserTypeLiteral</span><span class="p">]</span>
        <span class="n">ja3</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
        <span class="n">akamai</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
        <span class="n">extra_fp</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">ExtraFingerprints</span><span class="p">,</span> <span class="n">ExtraFpDict</span><span class="p">]]</span>
        <span class="n">default_headers</span><span class="p">:</span> <span class="nb">bool</span>
        <span class="n">default_encoding</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">bytes</span><span class="p">],</span> <span class="nb">str</span><span class="p">]]</span>
        <span class="n">curl_options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span>
        <span class="n">curl_infos</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span>
        <span class="n">http_version</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">CurlHttpVersion</span><span class="p">,</span> <span class="n">HttpVersionLiteral</span><span class="p">]]</span>
        <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span>
        <span class="n">interface</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
        <span class="n">cert</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]]</span>
        <span class="n">response_class</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">type</span><span class="p">[</span><span class="n">R</span><span class="p">]]</span>
        <span class="n">discard_cookies</span><span class="p">:</span> <span class="nb">bool</span>

    <span class="k">class</span><span class="w"> </span><span class="nc">StreamRequestParams</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]]</span>
        <span class="n">data</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">],</span> <span class="nb">str</span><span class="p">,</span> <span class="n">BytesIO</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]]</span>
        <span class="n">json</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span> <span class="o">|</span> <span class="nb">list</span><span class="p">]</span>
        <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">HeaderTypes</span><span class="p">]</span>
        <span class="n">cookies</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CookieTypes</span><span class="p">]</span>
        <span class="n">files</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span>
        <span class="n">auth</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="nb">object</span><span class="p">]]</span>
        <span class="n">allow_redirects</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span>
        <span class="n">max_redirects</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
        <span class="n">proxies</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ProxySpec</span><span class="p">]</span>
        <span class="n">proxy</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
        <span class="n">proxy_auth</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span>
        <span class="n">verify</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span>
        <span class="n">referer</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
        <span class="n">accept_encoding</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
        <span class="n">content_callback</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span>
        <span class="n">impersonate</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BrowserTypeLiteral</span><span class="p">]</span>
        <span class="n">ja3</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
        <span class="n">akamai</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
        <span class="n">extra_fp</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">ExtraFingerprints</span><span class="p">,</span> <span class="n">ExtraFpDict</span><span class="p">]]</span>
        <span class="n">default_headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span>
        <span class="n">default_encoding</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">bytes</span><span class="p">],</span> <span class="nb">str</span><span class="p">]]</span>
        <span class="n">quote</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Literal</span><span class="p">[</span><span class="kc">False</span><span class="p">]]</span>
        <span class="n">http_version</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">CurlHttpVersion</span><span class="p">,</span> <span class="n">HttpVersionLiteral</span><span class="p">]]</span>
        <span class="n">interface</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
        <span class="n">cert</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]]</span>
        <span class="n">max_recv_speed</span><span class="p">:</span> <span class="nb">int</span>
        <span class="n">multipart</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CurlMime</span><span class="p">]</span>
        <span class="n">discard_cookies</span><span class="p">:</span> <span class="nb">bool</span>

    <span class="k">class</span><span class="w"> </span><span class="nc">RequestParams</span><span class="p">(</span><span class="n">StreamRequestParams</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="n">stream</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span>

<span class="k">else</span><span class="p">:</span>

    <span class="k">class</span><span class="w"> </span><span class="nc">_Unpack</span><span class="p">:</span>
        <span class="nd">@staticmethod</span>
        <span class="k">def</span><span class="w"> </span><span class="fm">__getitem__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">pass</span>

    <span class="n">Unpack</span> <span class="o">=</span> <span class="n">_Unpack</span><span class="p">()</span>

    <span class="n">ProxySpec</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>
    <span class="n">BaseSessionParams</span> <span class="o">=</span> <span class="n">TypedDict</span>
    <span class="n">StreamRequestParams</span><span class="p">,</span> <span class="n">RequestParams</span> <span class="o">=</span> <span class="n">TypedDict</span><span class="p">,</span> <span class="n">TypedDict</span>

<span class="n">ThreadType</span> <span class="o">=</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;eventlet&quot;</span><span class="p">,</span> <span class="s2">&quot;gevent&quot;</span><span class="p">]</span>
<span class="n">HttpMethod</span> <span class="o">=</span> <span class="n">Literal</span><span class="p">[</span>
    <span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;POST&quot;</span><span class="p">,</span> <span class="s2">&quot;PUT&quot;</span><span class="p">,</span> <span class="s2">&quot;DELETE&quot;</span><span class="p">,</span> <span class="s2">&quot;OPTIONS&quot;</span><span class="p">,</span> <span class="s2">&quot;HEAD&quot;</span><span class="p">,</span> <span class="s2">&quot;TRACE&quot;</span><span class="p">,</span> <span class="s2">&quot;PATCH&quot;</span><span class="p">,</span> <span class="s2">&quot;QUERY&quot;</span>
<span class="p">]</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_is_absolute_url</span><span class="p">(</span><span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if the provided url is an absolute url&quot;&quot;&quot;</span>
    <span class="n">parsed_url</span> <span class="o">=</span> <span class="n">urlparse</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">parsed_url</span><span class="o">.</span><span class="n">scheme</span> <span class="ow">and</span> <span class="n">parsed_url</span><span class="o">.</span><span class="n">hostname</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_peek_queue</span><span class="p">(</span><span class="n">q</span><span class="p">:</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">q</span><span class="o">.</span><span class="n">queue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">default</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_peek_aio_queue</span><span class="p">(</span><span class="n">q</span><span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Queue</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">q</span><span class="o">.</span><span class="n">_queue</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># type: ignore</span>
    <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">default</span>


<span class="k">class</span><span class="w"> </span><span class="nc">BaseSession</span><span class="p">(</span><span class="n">Generic</span><span class="p">[</span><span class="n">R</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Provide common methods for setting curl options and reading info in sessions.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">HeaderTypes</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">cookies</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CookieTypes</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">auth</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">proxies</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ProxySpec</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">proxy</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">proxy_auth</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">base_url</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">verify</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span>
        <span class="n">trust_env</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">allow_redirects</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">max_redirects</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span>
        <span class="n">impersonate</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BrowserTypeLiteral</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ja3</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">akamai</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">extra_fp</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">ExtraFingerprints</span><span class="p">,</span> <span class="n">ExtraFpDict</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">default_headers</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">default_encoding</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">bytes</span><span class="p">],</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">,</span>
        <span class="n">curl_options</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">curl_infos</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">http_version</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">CurlHttpVersion</span><span class="p">,</span> <span class="n">HttpVersionLiteral</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">interface</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">cert</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">response_class</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">type</span><span class="p">[</span><span class="n">R</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">discard_cookies</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">headers</span> <span class="o">=</span> <span class="n">Headers</span><span class="p">(</span><span class="n">headers</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cookies</span> <span class="o">=</span> <span class="n">Cookies</span><span class="p">(</span><span class="n">cookies</span><span class="p">)</span>  <span class="c1"># guarded by @property</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">auth</span> <span class="o">=</span> <span class="n">auth</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span> <span class="o">=</span> <span class="n">base_url</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verify</span> <span class="o">=</span> <span class="n">verify</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">timeout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trust_env</span> <span class="o">=</span> <span class="n">trust_env</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allow_redirects</span> <span class="o">=</span> <span class="n">allow_redirects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_redirects</span> <span class="o">=</span> <span class="n">max_redirects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">impersonate</span> <span class="o">=</span> <span class="n">impersonate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ja3</span> <span class="o">=</span> <span class="n">ja3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">akamai</span> <span class="o">=</span> <span class="n">akamai</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extra_fp</span> <span class="o">=</span> <span class="n">extra_fp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_headers</span> <span class="o">=</span> <span class="n">default_headers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default_encoding</span> <span class="o">=</span> <span class="n">default_encoding</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curl_options</span> <span class="o">=</span> <span class="n">curl_options</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curl_infos</span> <span class="o">=</span> <span class="n">curl_infos</span> <span class="ow">or</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">http_version</span> <span class="o">=</span> <span class="n">http_version</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="n">debug</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interface</span> <span class="o">=</span> <span class="n">interface</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cert</span> <span class="o">=</span> <span class="n">cert</span>

        <span class="k">if</span> <span class="n">response_class</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">response_class</span><span class="p">,</span> <span class="n">Response</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s2">&quot;`response_class` must be a subclass of &quot;</span>
                <span class="s2">&quot;`curl_cffi.requests.models.Response`, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;not of type `</span><span class="si">{</span><span class="n">response_class</span><span class="si">}</span><span class="s2">`&quot;</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">response_class</span> <span class="o">=</span> <span class="n">response_class</span> <span class="ow">or</span> <span class="n">Response</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">discard_cookies</span> <span class="o">=</span> <span class="n">discard_cookies</span>

        <span class="k">if</span> <span class="n">proxy</span> <span class="ow">and</span> <span class="n">proxies</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Cannot specify both &#39;proxy&#39; and &#39;proxies&#39;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">proxy</span><span class="p">:</span>
            <span class="n">proxies</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;all&quot;</span><span class="p">:</span> <span class="n">proxy</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">proxies</span><span class="p">:</span> <span class="n">ProxySpec</span> <span class="o">=</span> <span class="n">proxies</span> <span class="ow">or</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">proxy_auth</span> <span class="o">=</span> <span class="n">proxy_auth</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_url</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">_is_absolute_url</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;You need to provide an absolute url for &#39;base_url&#39;&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_closed</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_response</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">curl</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">header_buffer</span><span class="p">,</span> <span class="n">default_encoding</span><span class="p">,</span> <span class="n">discard_cookies</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">R</span><span class="p">:</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">curl</span>
        <span class="n">rsp</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="n">R</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">response_class</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
        <span class="n">rsp</span><span class="o">.</span><span class="n">url</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">getinfo</span><span class="p">(</span><span class="n">CurlInfo</span><span class="o">.</span><span class="n">EFFECTIVE_URL</span><span class="p">))</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">buffer</span><span class="p">:</span>
            <span class="n">rsp</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="n">buffer</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
        <span class="n">rsp</span><span class="o">.</span><span class="n">http_version</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">getinfo</span><span class="p">(</span><span class="n">CurlInfo</span><span class="o">.</span><span class="n">HTTP_VERSION</span><span class="p">))</span>
        <span class="n">rsp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">getinfo</span><span class="p">(</span><span class="n">CurlInfo</span><span class="o">.</span><span class="n">RESPONSE_CODE</span><span class="p">))</span>
        <span class="n">rsp</span><span class="o">.</span><span class="n">ok</span> <span class="o">=</span> <span class="mi">200</span> <span class="o">&lt;=</span> <span class="n">rsp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">&lt;</span> <span class="mi">400</span>
        <span class="n">header_lines</span> <span class="o">=</span> <span class="n">header_buffer</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>

        <span class="c1"># TODO: history urls</span>
        <span class="n">header_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">bytes</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">header_line</span> <span class="ow">in</span> <span class="n">header_lines</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">header_line</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">header_line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;HTTP/&quot;</span><span class="p">):</span>
                <span class="c1"># read header from last response</span>
                <span class="n">rsp</span><span class="o">.</span><span class="n">reason</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">get_reason_phrase</span><span class="p">(</span><span class="n">header_line</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
                <span class="c1"># empty header list for new redirected response</span>
                <span class="n">header_list</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">header_line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot; &quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">header_line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="sa">b</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">):</span>
                <span class="n">header_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">header_line</span>
                <span class="k">continue</span>
            <span class="n">header_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">header_line</span><span class="p">)</span>
        <span class="n">rsp</span><span class="o">.</span><span class="n">headers</span> <span class="o">=</span> <span class="n">Headers</span><span class="p">(</span><span class="n">header_list</span><span class="p">)</span>

        <span class="c1"># Response cookies - only from Set-Cookie headers</span>
        <span class="n">rsp</span><span class="o">.</span><span class="n">cookies</span> <span class="o">=</span> <span class="n">Cookies</span><span class="p">()</span>
        <span class="n">set_cookie_headers</span> <span class="o">=</span> <span class="n">rsp</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get_list</span><span class="p">(</span><span class="s2">&quot;set-cookie&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">set_cookie</span> <span class="ow">in</span> <span class="n">set_cookie_headers</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">cookie</span> <span class="o">=</span> <span class="n">http</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">SimpleCookie</span><span class="p">()</span>
                <span class="n">cookie</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">set_cookie</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
                <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">morsel</span> <span class="ow">in</span> <span class="n">cookie</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">rsp</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">set</span><span class="p">(</span>
                        <span class="n">name</span><span class="p">,</span>
                        <span class="n">morsel</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                        <span class="n">domain</span><span class="o">=</span><span class="n">morsel</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;domain&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
                        <span class="n">path</span><span class="o">=</span><span class="n">morsel</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;path&quot;</span><span class="p">,</span> <span class="s2">&quot;/&quot;</span><span class="p">),</span>
                        <span class="n">secure</span><span class="o">=</span><span class="nb">bool</span><span class="p">(</span><span class="n">morsel</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;secure&quot;</span><span class="p">)),</span>
                    <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">continue</span>

        <span class="c1"># Session cookies - from full cookie store</span>
        <span class="n">discard_cookies</span> <span class="o">=</span> <span class="n">discard_cookies</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">discard_cookies</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">discard_cookies</span><span class="p">:</span>
            <span class="n">morsels</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">CurlMorsel</span><span class="o">.</span><span class="n">from_curl_format</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">getinfo</span><span class="p">(</span><span class="n">CurlInfo</span><span class="o">.</span><span class="n">COOKIELIST</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_cookies</span><span class="o">.</span><span class="n">update_cookies_from_curl</span><span class="p">(</span><span class="n">morsels</span><span class="p">)</span>

        <span class="n">rsp</span><span class="o">.</span><span class="n">primary_ip</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">getinfo</span><span class="p">(</span><span class="n">CurlInfo</span><span class="o">.</span><span class="n">PRIMARY_IP</span><span class="p">))</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="n">rsp</span><span class="o">.</span><span class="n">primary_port</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">getinfo</span><span class="p">(</span><span class="n">CurlInfo</span><span class="o">.</span><span class="n">PRIMARY_PORT</span><span class="p">))</span>
        <span class="n">rsp</span><span class="o">.</span><span class="n">local_ip</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">getinfo</span><span class="p">(</span><span class="n">CurlInfo</span><span class="o">.</span><span class="n">LOCAL_IP</span><span class="p">))</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="n">rsp</span><span class="o">.</span><span class="n">local_port</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">getinfo</span><span class="p">(</span><span class="n">CurlInfo</span><span class="o">.</span><span class="n">LOCAL_PORT</span><span class="p">))</span>
        <span class="n">rsp</span><span class="o">.</span><span class="n">default_encoding</span> <span class="o">=</span> <span class="n">default_encoding</span>
        <span class="n">rsp</span><span class="o">.</span><span class="n">elapsed</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">getinfo</span><span class="p">(</span><span class="n">CurlInfo</span><span class="o">.</span><span class="n">TOTAL_TIME</span><span class="p">))</span>
        <span class="n">rsp</span><span class="o">.</span><span class="n">redirect_count</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">getinfo</span><span class="p">(</span><span class="n">CurlInfo</span><span class="o">.</span><span class="n">REDIRECT_COUNT</span><span class="p">))</span>
        <span class="n">redirect_url_bytes</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="nb">bytes</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">getinfo</span><span class="p">(</span><span class="n">CurlInfo</span><span class="o">.</span><span class="n">REDIRECT_URL</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">rsp</span><span class="o">.</span><span class="n">redirect_url</span> <span class="o">=</span> <span class="n">redirect_url_bytes</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">UnicodeDecodeError</span><span class="p">:</span>
            <span class="n">rsp</span><span class="o">.</span><span class="n">redirect_url</span> <span class="o">=</span> <span class="n">redirect_url_bytes</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;latin-1&quot;</span><span class="p">)</span>

        <span class="c1"># custom info options</span>
        <span class="k">for</span> <span class="n">info</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">curl_infos</span><span class="p">:</span>
            <span class="n">rsp</span><span class="o">.</span><span class="n">infos</span><span class="p">[</span><span class="n">info</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">getinfo</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">rsp</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_check_session_closed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_closed</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SessionClosed</span><span class="p">(</span><span class="s2">&quot;Session is closed, cannot send request.&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">cookies</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Cookies</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cookies</span>

    <span class="nd">@cookies</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">cookies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cookies</span><span class="p">:</span> <span class="n">CookieTypes</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># This ensures that the cookies property is always converted to Cookies.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cookies</span> <span class="o">=</span> <span class="n">Cookies</span><span class="p">(</span><span class="n">cookies</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Session</span><span class="p">(</span><span class="n">BaseSession</span><span class="p">[</span><span class="n">R</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A request session, cookies and connections will be reused. This object is</span>
<span class="sd">    thread-safe, but it&#39;s recommended to use a separate session for each thread.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">curl</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Curl</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">thread</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ThreadType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">use_thread_local_curl</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Unpack</span><span class="p">[</span><span class="n">BaseSessionParams</span><span class="p">[</span><span class="n">R</span><span class="p">]],</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters set in the ``__init__`` method will be overriden by the same</span>
<span class="sd">        parameter in request method.</span>

<span class="sd">        Args:</span>
<span class="sd">            curl: curl object to use in the session. If not provided, a new one will be</span>
<span class="sd">                created. Also, a fresh curl object will always be created when accessed</span>
<span class="sd">                from another thread.</span>
<span class="sd">            thread: thread engine to use for working with other thread implementations.</span>
<span class="sd">                choices: eventlet, gevent.</span>
<span class="sd">            headers: headers to use in the session.</span>
<span class="sd">            cookies: cookies to add in the session.</span>
<span class="sd">            auth: HTTP basic auth, a tuple of (username, password), only basic auth is</span>
<span class="sd">                supported.</span>
<span class="sd">            proxies: dict of proxies to use, prefer to use proxy if they are the same.</span>
<span class="sd">                format: ``{&quot;http&quot;: proxy_url, &quot;https&quot;: proxy_url}``.</span>
<span class="sd">            proxy: proxy to use, format: &quot;http://proxy_url&quot;.</span>
<span class="sd">                Cannot be used with the above parameter.</span>
<span class="sd">            proxy_auth: HTTP basic auth for proxy, a tuple of (username, password).</span>
<span class="sd">            base_url: absolute url to use as base for relative urls.</span>
<span class="sd">            params: query string for the session.</span>
<span class="sd">            verify: whether to verify https certs.</span>
<span class="sd">            timeout: how many seconds to wait before giving up.</span>
<span class="sd">            trust_env: use http_proxy/https_proxy and other environments, default True.</span>
<span class="sd">            allow_redirects: whether to allow redirection.</span>
<span class="sd">            max_redirects: max redirect counts, default 30, use -1 for unlimited.</span>
<span class="sd">            impersonate: which browser version to impersonate in the session.</span>
<span class="sd">            ja3: ja3 string to impersonate in the session.</span>
<span class="sd">            akamai: akamai string to impersonate in the session.</span>
<span class="sd">            extra_fp: extra fingerprints options, in complement to ja3 and akamai str.</span>
<span class="sd">            interface: which interface use.</span>
<span class="sd">            default_encoding: encoding for decoding response content if charset is not</span>
<span class="sd">                found in headers. Defaults to &quot;utf-8&quot;. Can be set to a callable for</span>
<span class="sd">                automatic detection.</span>
<span class="sd">            cert: a tuple of (cert, key) filenames for client cert.</span>
<span class="sd">            response_class: A customized subtype of ``Response`` to use.</span>

<span class="sd">        Notes:</span>
<span class="sd">            This class can be used as a context manager.</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            from curl_cffi.requests import Session</span>

<span class="sd">            with Session() as s:</span>
<span class="sd">                r = s.get(&quot;https://example.com&quot;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_thread</span> <span class="o">=</span> <span class="n">thread</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_use_thread_local_curl</span> <span class="o">=</span> <span class="n">use_thread_local_curl</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_queue</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_executor</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">use_thread_local_curl</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_local</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">local</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">curl</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_is_customized_curl</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_local</span><span class="o">.</span><span class="n">curl</span> <span class="o">=</span> <span class="n">curl</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_is_customized_curl</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_local</span><span class="o">.</span><span class="n">curl</span> <span class="o">=</span> <span class="n">Curl</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_curl</span> <span class="o">=</span> <span class="n">curl</span> <span class="k">if</span> <span class="n">curl</span> <span class="k">else</span> <span class="n">Curl</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">curl</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_thread_local_curl</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_customized_curl</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="s2">&quot;Creating fresh curl handle in different thread.&quot;</span><span class="p">,</span>
                    <span class="n">CurlCffiWarning</span><span class="p">,</span>
                    <span class="n">stacklevel</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_local</span><span class="p">,</span> <span class="s2">&quot;curl&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_local</span><span class="o">.</span><span class="n">curl</span> <span class="o">=</span> <span class="n">Curl</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_local</span><span class="o">.</span><span class="n">curl</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_curl</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">executor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_executor</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_executor</span> <span class="o">=</span> <span class="n">ThreadPoolExecutor</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_executor</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Close the session.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_closed</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curl</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="nd">@contextmanager</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">stream</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">method</span><span class="p">:</span> <span class="n">HttpMethod</span><span class="p">,</span>
        <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Unpack</span><span class="p">[</span><span class="n">StreamRequestParams</span><span class="p">],</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Equivalent to ``with request(..., stream=True) as r:``&quot;&quot;&quot;</span>
        <span class="n">rsp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">rsp</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">rsp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">ws_connect</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">on_message</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">on_error</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">on_open</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">on_close</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">WebSocket</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Connects to a websocket url.</span>

<span class="sd">        Note: This method is deprecated, use WebSocket instead.</span>

<span class="sd">        Args:</span>
<span class="sd">            url: the ws url to connect.</span>
<span class="sd">            on_message: message callback, ``def on_message(ws, str)``</span>
<span class="sd">            on_error: error callback, ``def on_error(ws, error)``</span>
<span class="sd">            on_open: open callback, ``def on_open(ws)``</span>
<span class="sd">            on_close: close callback, ``def on_close(ws)``</span>

<span class="sd">        Other parameters are the same as ``.request``</span>

<span class="sd">        Returns:</span>
<span class="sd">            a WebSocket instance to communicate with the server.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_session_closed</span><span class="p">()</span>

        <span class="n">curl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">curl</span><span class="o">.</span><span class="n">duphandle</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">curl</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

        <span class="n">ws</span> <span class="o">=</span> <span class="n">WebSocket</span><span class="p">(</span>
            <span class="n">curl</span><span class="o">=</span><span class="n">curl</span><span class="p">,</span>
            <span class="n">on_message</span><span class="o">=</span><span class="n">on_message</span><span class="p">,</span>
            <span class="n">on_error</span><span class="o">=</span><span class="n">on_error</span><span class="p">,</span>
            <span class="n">on_open</span><span class="o">=</span><span class="n">on_open</span><span class="p">,</span>
            <span class="n">on_close</span><span class="o">=</span><span class="n">on_close</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">ws</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ws</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">upkeep</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">curl</span><span class="o">.</span><span class="n">upkeep</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">request</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">method</span><span class="p">:</span> <span class="n">HttpMethod</span><span class="p">,</span>
        <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">data</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">],</span> <span class="nb">str</span><span class="p">,</span> <span class="n">BytesIO</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">json</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span> <span class="o">|</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">HeaderTypes</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">cookies</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CookieTypes</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">files</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">auth</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="nb">object</span><span class="p">]]</span> <span class="o">=</span> <span class="n">not_set</span><span class="p">,</span>
        <span class="n">allow_redirects</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">max_redirects</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">proxies</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ProxySpec</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">proxy</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">proxy_auth</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">verify</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">referer</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">accept_encoding</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;gzip, deflate, br&quot;</span><span class="p">,</span>
        <span class="n">content_callback</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">impersonate</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BrowserTypeLiteral</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ja3</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">akamai</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">extra_fp</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">ExtraFingerprints</span><span class="p">,</span> <span class="n">ExtraFpDict</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">default_headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">default_encoding</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">bytes</span><span class="p">],</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">,</span>
        <span class="n">quote</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Literal</span><span class="p">[</span><span class="kc">False</span><span class="p">]]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">http_version</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">CurlHttpVersion</span><span class="p">,</span> <span class="n">HttpVersionLiteral</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">interface</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">cert</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">stream</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">max_recv_speed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">multipart</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CurlMime</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">discard_cookies</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Send the request, see ``requests.request`` for details on parameters.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_check_session_closed</span><span class="p">()</span>

        <span class="c1"># clone a new curl instance for streaming response</span>
        <span class="k">if</span> <span class="n">stream</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">curl</span><span class="o">.</span><span class="n">duphandle</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">curl</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">curl</span>

        <span class="n">req</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">header_buffer</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">header_recved</span><span class="p">,</span> <span class="n">quit_now</span> <span class="o">=</span> <span class="n">set_curl_options</span><span class="p">(</span>
            <span class="n">c</span><span class="p">,</span>
            <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>
            <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span>
            <span class="n">params_list</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">params</span><span class="p">],</span>
            <span class="n">base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
            <span class="n">json</span><span class="o">=</span><span class="n">json</span><span class="p">,</span>
            <span class="n">headers_list</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">,</span> <span class="n">headers</span><span class="p">],</span>
            <span class="n">cookies_list</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_cookies</span><span class="p">,</span> <span class="n">cookies</span><span class="p">],</span>
            <span class="n">files</span><span class="o">=</span><span class="n">files</span><span class="p">,</span>
            <span class="n">auth</span><span class="o">=</span><span class="n">auth</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">auth</span><span class="p">,</span>
            <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="k">if</span> <span class="n">timeout</span> <span class="ow">is</span> <span class="n">not_set</span> <span class="k">else</span> <span class="n">timeout</span><span class="p">,</span>
            <span class="n">allow_redirects</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">allow_redirects</span>
            <span class="k">if</span> <span class="n">allow_redirects</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="k">else</span> <span class="n">allow_redirects</span><span class="p">,</span>
            <span class="n">max_redirects</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_redirects</span>
            <span class="k">if</span> <span class="n">max_redirects</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="k">else</span> <span class="n">max_redirects</span><span class="p">,</span>
            <span class="n">proxies_list</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">proxies</span><span class="p">,</span> <span class="n">proxies</span><span class="p">],</span>
            <span class="n">proxy</span><span class="o">=</span><span class="n">proxy</span><span class="p">,</span>
            <span class="n">proxy_auth</span><span class="o">=</span><span class="n">proxy_auth</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxy_auth</span><span class="p">,</span>
            <span class="n">verify_list</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">verify</span><span class="p">,</span> <span class="n">verify</span><span class="p">],</span>
            <span class="n">referer</span><span class="o">=</span><span class="n">referer</span><span class="p">,</span>
            <span class="n">accept_encoding</span><span class="o">=</span><span class="n">accept_encoding</span><span class="p">,</span>
            <span class="n">content_callback</span><span class="o">=</span><span class="n">content_callback</span><span class="p">,</span>
            <span class="n">impersonate</span><span class="o">=</span><span class="n">impersonate</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">impersonate</span><span class="p">,</span>
            <span class="n">ja3</span><span class="o">=</span><span class="n">ja3</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">ja3</span><span class="p">,</span>
            <span class="n">akamai</span><span class="o">=</span><span class="n">akamai</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">akamai</span><span class="p">,</span>
            <span class="n">extra_fp</span><span class="o">=</span><span class="n">extra_fp</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">extra_fp</span><span class="p">,</span>
            <span class="n">default_headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_headers</span>
            <span class="k">if</span> <span class="n">default_headers</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="k">else</span> <span class="n">default_headers</span><span class="p">,</span>
            <span class="n">quote</span><span class="o">=</span><span class="n">quote</span><span class="p">,</span>
            <span class="n">http_version</span><span class="o">=</span><span class="n">http_version</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">http_version</span><span class="p">,</span>
            <span class="n">interface</span><span class="o">=</span><span class="n">interface</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">interface</span><span class="p">,</span>
            <span class="n">stream</span><span class="o">=</span><span class="n">stream</span><span class="p">,</span>
            <span class="n">max_recv_speed</span><span class="o">=</span><span class="n">max_recv_speed</span><span class="p">,</span>
            <span class="n">multipart</span><span class="o">=</span><span class="n">multipart</span><span class="p">,</span>
            <span class="n">cert</span><span class="o">=</span><span class="n">cert</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">cert</span><span class="p">,</span>
            <span class="n">curl_options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">curl_options</span><span class="p">,</span>
            <span class="n">queue_class</span><span class="o">=</span><span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">,</span>
            <span class="n">event_class</span><span class="o">=</span><span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">stream</span><span class="p">:</span>
            <span class="n">header_parsed</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">perform</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">c</span><span class="o">.</span><span class="n">perform</span><span class="p">()</span>
                <span class="k">except</span> <span class="n">CurlError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">rsp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_response</span><span class="p">(</span>
                        <span class="n">c</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">header_buffer</span><span class="p">,</span> <span class="n">default_encoding</span><span class="p">,</span> <span class="n">discard_cookies</span>
                    <span class="p">)</span>
                    <span class="n">rsp</span><span class="o">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">req</span>
                    <span class="n">q</span><span class="o">.</span><span class="n">put_nowait</span><span class="p">(</span><span class="n">RequestException</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">e</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="n">rsp</span><span class="p">))</span>  <span class="c1"># type: ignore</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">cast</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">,</span> <span class="n">header_recved</span><span class="p">)</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                        <span class="n">cast</span><span class="p">(</span><span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">,</span> <span class="n">header_recved</span><span class="p">)</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
                    <span class="n">q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">STREAM_END</span><span class="p">)</span>  <span class="c1"># type: ignore</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">cleanup</span><span class="p">(</span><span class="n">fut</span><span class="p">):</span>
                <span class="n">header_parsed</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
                <span class="n">c</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

            <span class="n">stream_task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">perform</span><span class="p">)</span>
            <span class="n">stream_task</span><span class="o">.</span><span class="n">add_done_callback</span><span class="p">(</span><span class="n">cleanup</span><span class="p">)</span>

            <span class="c1"># Wait for the first chunk</span>
            <span class="n">header_recved</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>  <span class="c1"># type: ignore</span>
            <span class="n">rsp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_response</span><span class="p">(</span>
                <span class="n">c</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">header_buffer</span><span class="p">,</span> <span class="n">default_encoding</span><span class="p">,</span> <span class="n">discard_cookies</span>
            <span class="p">)</span>

            <span class="n">header_parsed</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

            <span class="c1"># Raise the exception if something wrong happens when receiving the header.</span>
            <span class="n">first_element</span> <span class="o">=</span> <span class="n">_peek_queue</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">first_element</span><span class="p">,</span> <span class="n">RequestException</span><span class="p">):</span>
                <span class="n">c</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
                <span class="k">raise</span> <span class="n">first_element</span>

            <span class="n">rsp</span><span class="o">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">req</span>
            <span class="n">rsp</span><span class="o">.</span><span class="n">stream_task</span> <span class="o">=</span> <span class="n">stream_task</span>
            <span class="n">rsp</span><span class="o">.</span><span class="n">quit_now</span> <span class="o">=</span> <span class="n">quit_now</span>
            <span class="n">rsp</span><span class="o">.</span><span class="n">queue</span> <span class="o">=</span> <span class="n">q</span>
            <span class="k">return</span> <span class="n">rsp</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_thread</span> <span class="o">==</span> <span class="s2">&quot;eventlet&quot;</span><span class="p">:</span>
                    <span class="c1"># see: https://eventlet.net/doc/threading.html</span>
                    <span class="n">eventlet</span><span class="o">.</span><span class="n">tpool</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">perform</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
                <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_thread</span> <span class="o">==</span> <span class="s2">&quot;gevent&quot;</span><span class="p">:</span>
                    <span class="c1"># see: https://www.gevent.org/api/gevent.threadpool.html</span>
                    <span class="n">gevent</span><span class="o">.</span><span class="n">get_hub</span><span class="p">()</span><span class="o">.</span><span class="n">threadpool</span><span class="o">.</span><span class="n">spawn</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">perform</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>  <span class="c1"># type: ignore</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">c</span><span class="o">.</span><span class="n">perform</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">CurlError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">rsp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_response</span><span class="p">(</span>
                    <span class="n">c</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">header_buffer</span><span class="p">,</span> <span class="n">default_encoding</span><span class="p">,</span> <span class="n">discard_cookies</span>
                <span class="p">)</span>
                <span class="n">rsp</span><span class="o">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">req</span>
                <span class="n">error</span> <span class="o">=</span> <span class="n">code2error</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                <span class="k">raise</span> <span class="n">error</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">e</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="n">rsp</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rsp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_response</span><span class="p">(</span>
                    <span class="n">c</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">header_buffer</span><span class="p">,</span> <span class="n">default_encoding</span><span class="p">,</span> <span class="n">discard_cookies</span>
                <span class="p">)</span>
                <span class="n">rsp</span><span class="o">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">req</span>
                <span class="k">return</span> <span class="n">rsp</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="n">c</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">head</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Unpack</span><span class="p">[</span><span class="n">RequestParams</span><span class="p">]):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;HEAD&quot;</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Unpack</span><span class="p">[</span><span class="n">RequestParams</span><span class="p">]):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Unpack</span><span class="p">[</span><span class="n">RequestParams</span><span class="p">]):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;POST&quot;</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Unpack</span><span class="p">[</span><span class="n">RequestParams</span><span class="p">]):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;PUT&quot;</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">patch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Unpack</span><span class="p">[</span><span class="n">RequestParams</span><span class="p">]):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;PATCH&quot;</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Unpack</span><span class="p">[</span><span class="n">RequestParams</span><span class="p">]):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;DELETE&quot;</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Unpack</span><span class="p">[</span><span class="n">RequestParams</span><span class="p">]):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;OPTIONS&quot;</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">trace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Unpack</span><span class="p">[</span><span class="n">RequestParams</span><span class="p">]):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;TRACE&quot;</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Unpack</span><span class="p">[</span><span class="n">RequestParams</span><span class="p">]):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;QUERY&quot;</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">AsyncSession</span><span class="p">(</span><span class="n">BaseSession</span><span class="p">[</span><span class="n">R</span><span class="p">]):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;An async request session, cookies and connections will be reused.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">loop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">async_curl</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">AsyncCurl</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">max_clients</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Unpack</span><span class="p">[</span><span class="n">BaseSessionParams</span><span class="p">[</span><span class="n">R</span><span class="p">]],</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters set in the ``__init__`` method will be override by the same parameter</span>
<span class="sd">        in request method.</span>

<span class="sd">        Parameters:</span>
<span class="sd">            loop: loop to use, if not provided, the running loop will be used.</span>
<span class="sd">            async_curl: [AsyncCurl](/api/curl_cffi#curl_cffi.AsyncCurl) object to use.</span>
<span class="sd">            max_clients: maxmium curl handle to use in the session,</span>
<span class="sd">                this will affect the concurrency ratio.</span>
<span class="sd">            headers: headers to use in the session.</span>
<span class="sd">            cookies: cookies to add in the session.</span>
<span class="sd">            auth: HTTP basic auth, a tuple of (username, password), only basic auth is</span>
<span class="sd">                supported.</span>
<span class="sd">            proxies: dict of proxies to use, prefer to use ``proxy`` if they are the</span>
<span class="sd">                same. format: ``{&quot;http&quot;: proxy_url, &quot;https&quot;: proxy_url}``.</span>
<span class="sd">            proxy: proxy to use, format: &quot;http://proxy_url&quot;.</span>
<span class="sd">                Cannot be used with the above parameter.</span>
<span class="sd">            proxy_auth: HTTP basic auth for proxy, a tuple of (username, password).</span>
<span class="sd">            base_url: absolute url to use for relative urls.</span>
<span class="sd">            params: query string for the session.</span>
<span class="sd">            verify: whether to verify https certs.</span>
<span class="sd">            timeout: how many seconds to wait before giving up.</span>
<span class="sd">            trust_env: use http_proxy/https_proxy and other environments, default True.</span>
<span class="sd">            allow_redirects: whether to allow redirection.</span>
<span class="sd">            max_redirects: max redirect counts, default 30, use -1 for unlimited.</span>
<span class="sd">            impersonate: which browser version to impersonate in the session.</span>
<span class="sd">            ja3: ja3 string to impersonate in the session.</span>
<span class="sd">            akamai: akamai string to impersonate in the session.</span>
<span class="sd">            extra_fp: extra fingerprints options, in complement to ja3 and akamai str.</span>
<span class="sd">            default_encoding: encoding for decoding response content if charset is not</span>
<span class="sd">                found in headers. Defaults to &quot;utf-8&quot;. Can be set to a callable for</span>
<span class="sd">                automatic detection.</span>
<span class="sd">            cert: a tuple of (cert, key) filenames for client cert.</span>
<span class="sd">            response_class: A customized subtype of ``Response`` to use.</span>

<span class="sd">        Notes:</span>
<span class="sd">            This class can be used as a context manager, and it&#39;s recommended to use via</span>
<span class="sd">            ``async with``.</span>
<span class="sd">            However, unlike aiohttp, it is not required to use ``with``.</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            from curl_cffi.requests import AsyncSession</span>

<span class="sd">            # recommended.</span>
<span class="sd">            async with AsyncSession() as s:</span>
<span class="sd">                r = await s.get(&quot;https://example.com&quot;)</span>

<span class="sd">            s = AsyncSession()  # it also works.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loop</span> <span class="o">=</span> <span class="n">loop</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_acurl</span> <span class="o">=</span> <span class="n">async_curl</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_clients</span> <span class="o">=</span> <span class="n">max_clients</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_pool</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">loop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_running_loop</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loop</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">acurl</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_acurl</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_acurl</span> <span class="o">=</span> <span class="n">AsyncCurl</span><span class="p">(</span><span class="n">loop</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_acurl</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">init_pool</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pool</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">LifoQueue</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_clients</span><span class="p">)</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">put_nowait</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">QueueFull</span><span class="p">:</span>
                <span class="k">break</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">pop_curl</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">curl</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">curl</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">curl</span> <span class="o">=</span> <span class="n">Curl</span><span class="p">(</span><span class="n">debug</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">)</span>
        <span class="c1"># XXX: This may be related to proxy rotation</span>
        <span class="c1"># curl.setopt(CurlOpt.FRESH_CONNECT, 1)</span>
        <span class="c1"># curl.setopt(CurlOpt.FORBID_REUSE, 1)</span>
        <span class="k">return</span> <span class="n">curl</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">push_curl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">curl</span><span class="p">):</span>
        <span class="k">with</span> <span class="n">suppress</span><span class="p">(</span><span class="n">asyncio</span><span class="o">.</span><span class="n">QueueFull</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">put_nowait</span><span class="p">(</span><span class="n">curl</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="fm">__aenter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="fm">__aexit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Close the session.&quot;&quot;&quot;</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">acurl</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_closed</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">curl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pool</span><span class="o">.</span><span class="n">get_nowait</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">curl</span><span class="p">:</span>
                    <span class="n">curl</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">QueueEmpty</span><span class="p">:</span>
                <span class="k">break</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">release_curl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">curl</span><span class="p">):</span>
        <span class="n">curl</span><span class="o">.</span><span class="n">clean_after_perform</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_closed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">acurl</span><span class="o">.</span><span class="n">remove_handle</span><span class="p">(</span><span class="n">curl</span><span class="p">)</span>
            <span class="n">curl</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
            <span class="c1"># curl.setopt(CurlOpt.PIPEWAIT, 1)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">push_curl</span><span class="p">(</span><span class="n">curl</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">curl</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="nd">@asynccontextmanager</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">stream</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">method</span><span class="p">:</span> <span class="n">HttpMethod</span><span class="p">,</span>
        <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Unpack</span><span class="p">[</span><span class="n">StreamRequestParams</span><span class="p">],</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Equivalent to ``async with request(..., stream=True) as r:``&quot;&quot;&quot;</span>
        <span class="n">rsp</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">rsp</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">rsp</span><span class="o">.</span><span class="n">aclose</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">ws_connect</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">autoclose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">HeaderTypes</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">cookies</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CookieTypes</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">auth</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="nb">object</span><span class="p">]]</span> <span class="o">=</span> <span class="n">not_set</span><span class="p">,</span>
        <span class="n">allow_redirects</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">max_redirects</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">proxies</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ProxySpec</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">proxy</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">proxy_auth</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">verify</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">referer</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">accept_encoding</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;gzip, deflate, br&quot;</span><span class="p">,</span>
        <span class="n">impersonate</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BrowserTypeLiteral</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ja3</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">akamai</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">extra_fp</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">ExtraFingerprints</span><span class="p">,</span> <span class="n">ExtraFpDict</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">default_headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">quote</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Literal</span><span class="p">[</span><span class="kc">False</span><span class="p">]]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">http_version</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">CurlHttpVersion</span><span class="p">,</span> <span class="n">HttpVersionLiteral</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">interface</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">cert</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">max_recv_speed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncWebSocket</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Connects to a WebSocket.</span>

<span class="sd">        Args:</span>
<span class="sd">            url: url for the requests.</span>
<span class="sd">            autoclose: whether to close the WebSocket after receiving a close frame.</span>
<span class="sd">            params: query string for the requests.</span>
<span class="sd">            headers: headers to send.</span>
<span class="sd">            cookies: cookies to use.</span>
<span class="sd">            auth: HTTP basic auth, a tuple of (username, password), only basic auth is</span>
<span class="sd">                supported.</span>
<span class="sd">            timeout: how many seconds to wait before giving up.</span>
<span class="sd">            allow_redirects: whether to allow redirection.</span>
<span class="sd">            max_redirects: max redirect counts, default 30, use -1 for unlimited.</span>
<span class="sd">            proxies: dict of proxies to use, prefer to use ``proxy`` if they are the</span>
<span class="sd">                same. format: ``{&quot;http&quot;: proxy_url, &quot;https&quot;: proxy_url}``.</span>
<span class="sd">            proxy: proxy to use, format: &quot;http://user@pass:proxy_url&quot;.</span>
<span class="sd">                Can&#39;t be used with `proxies` parameter.</span>
<span class="sd">            proxy_auth: HTTP basic auth for proxy, a tuple of (username, password).</span>
<span class="sd">            verify: whether to verify https certs.</span>
<span class="sd">            referer: shortcut for setting referer header.</span>
<span class="sd">            accept_encoding: shortcut for setting accept-encoding header.</span>
<span class="sd">            impersonate: which browser version to impersonate.</span>
<span class="sd">            ja3: ja3 string to impersonate.</span>
<span class="sd">            akamai: akamai string to impersonate.</span>
<span class="sd">            extra_fp: extra fingerprints options, in complement to ja3 and akamai str.</span>
<span class="sd">            default_headers: whether to set default browser headers.</span>
<span class="sd">            quote: Set characters to be quoted, i.e. percent-encoded. Default safe</span>
<span class="sd">                string is ``!#$%&amp;&#39;()*+,/:;=?@[]~``. If set to a sting, the character</span>
<span class="sd">                will be removed from the safe string, thus quoted. If set to False, the</span>
<span class="sd">                url will be kept as is, without any automatic percent-encoding, you must</span>
<span class="sd">                encode the URL yourself.</span>
<span class="sd">            curl_options: extra curl options to use.</span>
<span class="sd">            http_version: limiting http version, defaults to http2.</span>
<span class="sd">            interface: which interface to use.</span>
<span class="sd">            cert: a tuple of (cert, key) filenames for client cert.</span>
<span class="sd">            max_recv_speed: maximum receive speed, bytes per second.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_check_session_closed</span><span class="p">()</span>

        <span class="n">curl</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop_curl</span><span class="p">()</span>
        <span class="n">set_curl_options</span><span class="p">(</span>
            <span class="n">curl</span><span class="o">=</span><span class="n">curl</span><span class="p">,</span>
            <span class="n">method</span><span class="o">=</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span>
            <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span>
            <span class="n">base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">,</span>
            <span class="n">params_list</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">params</span><span class="p">],</span>
            <span class="n">headers_list</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">,</span> <span class="n">headers</span><span class="p">],</span>
            <span class="n">cookies_list</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cookies</span><span class="p">,</span> <span class="n">cookies</span><span class="p">],</span>
            <span class="n">auth</span><span class="o">=</span><span class="n">auth</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">auth</span><span class="p">,</span>
            <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="k">if</span> <span class="n">timeout</span> <span class="ow">is</span> <span class="n">not_set</span> <span class="k">else</span> <span class="n">timeout</span><span class="p">,</span>
            <span class="n">allow_redirects</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">allow_redirects</span>
            <span class="k">if</span> <span class="n">allow_redirects</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="k">else</span> <span class="n">allow_redirects</span><span class="p">,</span>
            <span class="n">max_redirects</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_redirects</span>
            <span class="k">if</span> <span class="n">max_redirects</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="k">else</span> <span class="n">max_redirects</span><span class="p">,</span>
            <span class="n">proxies_list</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">proxies</span><span class="p">,</span> <span class="n">proxies</span><span class="p">],</span>
            <span class="n">proxy</span><span class="o">=</span><span class="n">proxy</span><span class="p">,</span>
            <span class="n">proxy_auth</span><span class="o">=</span><span class="n">proxy_auth</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxy_auth</span><span class="p">,</span>
            <span class="n">verify_list</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">verify</span><span class="p">,</span> <span class="n">verify</span><span class="p">],</span>
            <span class="n">referer</span><span class="o">=</span><span class="n">referer</span><span class="p">,</span>
            <span class="n">accept_encoding</span><span class="o">=</span><span class="n">accept_encoding</span><span class="p">,</span>
            <span class="n">impersonate</span><span class="o">=</span><span class="n">impersonate</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">impersonate</span><span class="p">,</span>
            <span class="n">ja3</span><span class="o">=</span><span class="n">ja3</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">ja3</span><span class="p">,</span>
            <span class="n">akamai</span><span class="o">=</span><span class="n">akamai</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">akamai</span><span class="p">,</span>
            <span class="n">extra_fp</span><span class="o">=</span><span class="n">extra_fp</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">extra_fp</span><span class="p">,</span>
            <span class="n">default_headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_headers</span>
            <span class="k">if</span> <span class="n">default_headers</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="k">else</span> <span class="n">default_headers</span><span class="p">,</span>
            <span class="n">quote</span><span class="o">=</span><span class="n">quote</span><span class="p">,</span>
            <span class="n">http_version</span><span class="o">=</span><span class="n">http_version</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">http_version</span><span class="p">,</span>
            <span class="n">interface</span><span class="o">=</span><span class="n">interface</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">interface</span><span class="p">,</span>
            <span class="n">max_recv_speed</span><span class="o">=</span><span class="n">max_recv_speed</span><span class="p">,</span>
            <span class="n">cert</span><span class="o">=</span><span class="n">cert</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">cert</span><span class="p">,</span>
            <span class="n">queue_class</span><span class="o">=</span><span class="n">asyncio</span><span class="o">.</span><span class="n">Queue</span><span class="p">,</span>
            <span class="n">event_class</span><span class="o">=</span><span class="n">asyncio</span><span class="o">.</span><span class="n">Event</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">curl</span><span class="o">.</span><span class="n">setopt</span><span class="p">(</span><span class="n">CurlOpt</span><span class="o">.</span><span class="n">CONNECT_ONLY</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>  <span class="c1"># https://curl.se/docs/websocket.html</span>

        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">run_in_executor</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">curl</span><span class="o">.</span><span class="n">perform</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">AsyncWebSocket</span><span class="p">(</span>
            <span class="n">cast</span><span class="p">(</span><span class="n">AsyncSession</span><span class="p">[</span><span class="n">Response</span><span class="p">],</span> <span class="bp">self</span><span class="p">),</span>
            <span class="n">curl</span><span class="p">,</span>
            <span class="n">autoclose</span><span class="o">=</span><span class="n">autoclose</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">request</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">method</span><span class="p">:</span> <span class="n">HttpMethod</span><span class="p">,</span>
        <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">params</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">data</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="nb">list</span><span class="p">[</span><span class="nb">tuple</span><span class="p">],</span> <span class="nb">str</span><span class="p">,</span> <span class="n">BytesIO</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">json</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span> <span class="o">|</span> <span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">HeaderTypes</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">cookies</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CookieTypes</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">files</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">auth</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="nb">object</span><span class="p">]]</span> <span class="o">=</span> <span class="n">not_set</span><span class="p">,</span>
        <span class="n">allow_redirects</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">max_redirects</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">proxies</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ProxySpec</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">proxy</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">proxy_auth</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">verify</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">referer</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">accept_encoding</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;gzip, deflate, br&quot;</span><span class="p">,</span>
        <span class="n">content_callback</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">impersonate</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">BrowserTypeLiteral</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">ja3</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">akamai</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">extra_fp</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">ExtraFingerprints</span><span class="p">,</span> <span class="n">ExtraFpDict</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">default_headers</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">default_encoding</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">bytes</span><span class="p">],</span> <span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="s2">&quot;utf-8&quot;</span><span class="p">,</span>
        <span class="n">quote</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Literal</span><span class="p">[</span><span class="kc">False</span><span class="p">]]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">http_version</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">CurlHttpVersion</span><span class="p">,</span> <span class="n">HttpVersionLiteral</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">interface</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">cert</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">stream</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">max_recv_speed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="n">multipart</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">CurlMime</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">discard_cookies</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Send the request, see ``curl_cffi.requests.request`` for details on args.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_check_session_closed</span><span class="p">()</span>

        <span class="n">curl</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop_curl</span><span class="p">()</span>
        <span class="n">req</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">header_buffer</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">header_recved</span><span class="p">,</span> <span class="n">quit_now</span> <span class="o">=</span> <span class="n">set_curl_options</span><span class="p">(</span>
            <span class="n">curl</span><span class="o">=</span><span class="n">curl</span><span class="p">,</span>
            <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">,</span>
            <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span>
            <span class="n">params_list</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">params</span><span class="p">],</span>
            <span class="n">base_url</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="p">,</span>
            <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
            <span class="n">json</span><span class="o">=</span><span class="n">json</span><span class="p">,</span>
            <span class="n">headers_list</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="p">,</span> <span class="n">headers</span><span class="p">],</span>
            <span class="n">cookies_list</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">cookies</span><span class="p">,</span> <span class="n">cookies</span><span class="p">],</span>
            <span class="n">files</span><span class="o">=</span><span class="n">files</span><span class="p">,</span>
            <span class="n">auth</span><span class="o">=</span><span class="n">auth</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">auth</span><span class="p">,</span>
            <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">timeout</span> <span class="k">if</span> <span class="n">timeout</span> <span class="ow">is</span> <span class="n">not_set</span> <span class="k">else</span> <span class="n">timeout</span><span class="p">,</span>
            <span class="n">allow_redirects</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">allow_redirects</span>
            <span class="k">if</span> <span class="n">allow_redirects</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="k">else</span> <span class="n">allow_redirects</span><span class="p">,</span>
            <span class="n">max_redirects</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_redirects</span>
            <span class="k">if</span> <span class="n">max_redirects</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="k">else</span> <span class="n">max_redirects</span><span class="p">,</span>
            <span class="n">proxies_list</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">proxies</span><span class="p">,</span> <span class="n">proxies</span><span class="p">],</span>
            <span class="n">proxy</span><span class="o">=</span><span class="n">proxy</span><span class="p">,</span>
            <span class="n">proxy_auth</span><span class="o">=</span><span class="n">proxy_auth</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">proxy_auth</span><span class="p">,</span>
            <span class="n">verify_list</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">verify</span><span class="p">,</span> <span class="n">verify</span><span class="p">],</span>
            <span class="n">referer</span><span class="o">=</span><span class="n">referer</span><span class="p">,</span>
            <span class="n">accept_encoding</span><span class="o">=</span><span class="n">accept_encoding</span><span class="p">,</span>
            <span class="n">content_callback</span><span class="o">=</span><span class="n">content_callback</span><span class="p">,</span>
            <span class="n">impersonate</span><span class="o">=</span><span class="n">impersonate</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">impersonate</span><span class="p">,</span>
            <span class="n">ja3</span><span class="o">=</span><span class="n">ja3</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">ja3</span><span class="p">,</span>
            <span class="n">akamai</span><span class="o">=</span><span class="n">akamai</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">akamai</span><span class="p">,</span>
            <span class="n">extra_fp</span><span class="o">=</span><span class="n">extra_fp</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">extra_fp</span><span class="p">,</span>
            <span class="n">default_headers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default_headers</span>
            <span class="k">if</span> <span class="n">default_headers</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="k">else</span> <span class="n">default_headers</span><span class="p">,</span>
            <span class="n">quote</span><span class="o">=</span><span class="n">quote</span><span class="p">,</span>
            <span class="n">http_version</span><span class="o">=</span><span class="n">http_version</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">http_version</span><span class="p">,</span>
            <span class="n">interface</span><span class="o">=</span><span class="n">interface</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">interface</span><span class="p">,</span>
            <span class="n">stream</span><span class="o">=</span><span class="n">stream</span><span class="p">,</span>
            <span class="n">max_recv_speed</span><span class="o">=</span><span class="n">max_recv_speed</span><span class="p">,</span>
            <span class="n">multipart</span><span class="o">=</span><span class="n">multipart</span><span class="p">,</span>
            <span class="n">cert</span><span class="o">=</span><span class="n">cert</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">cert</span><span class="p">,</span>
            <span class="n">curl_options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">curl_options</span><span class="p">,</span>
            <span class="n">queue_class</span><span class="o">=</span><span class="n">asyncio</span><span class="o">.</span><span class="n">Queue</span><span class="p">,</span>
            <span class="n">event_class</span><span class="o">=</span><span class="n">asyncio</span><span class="o">.</span><span class="n">Event</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">stream</span><span class="p">:</span>
            <span class="n">task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">acurl</span><span class="o">.</span><span class="n">add_handle</span><span class="p">(</span><span class="n">curl</span><span class="p">)</span>

            <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">perform</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">task</span>
                <span class="k">except</span> <span class="n">CurlError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">rsp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_response</span><span class="p">(</span>
                        <span class="n">curl</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">header_buffer</span><span class="p">,</span> <span class="n">default_encoding</span><span class="p">,</span> <span class="n">discard_cookies</span>
                    <span class="p">)</span>
                    <span class="n">rsp</span><span class="o">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">req</span>
                    <span class="n">q</span><span class="o">.</span><span class="n">put_nowait</span><span class="p">(</span><span class="n">RequestException</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">e</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="n">rsp</span><span class="p">))</span>  <span class="c1"># type: ignore</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">cast</span><span class="p">(</span><span class="n">asyncio</span><span class="o">.</span><span class="n">Event</span><span class="p">,</span> <span class="n">header_recved</span><span class="p">)</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                        <span class="n">cast</span><span class="p">(</span><span class="n">asyncio</span><span class="o">.</span><span class="n">Event</span><span class="p">,</span> <span class="n">header_recved</span><span class="p">)</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
                    <span class="k">await</span> <span class="n">q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">STREAM_END</span><span class="p">)</span>  <span class="c1"># type: ignore</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">cleanup</span><span class="p">(</span><span class="n">fut</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">release_curl</span><span class="p">(</span><span class="n">curl</span><span class="p">)</span>

            <span class="n">stream_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">perform</span><span class="p">())</span>
            <span class="n">stream_task</span><span class="o">.</span><span class="n">add_done_callback</span><span class="p">(</span><span class="n">cleanup</span><span class="p">)</span>

            <span class="k">await</span> <span class="n">cast</span><span class="p">(</span><span class="n">asyncio</span><span class="o">.</span><span class="n">Event</span><span class="p">,</span> <span class="n">header_recved</span><span class="p">)</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

            <span class="c1"># Unlike threads, coroutines does not use preemptive scheduling.</span>
            <span class="c1"># For asyncio, there is no need for a header_parsed event, the</span>
            <span class="c1"># _parse_response will execute in the foreground, no background tasks</span>
            <span class="c1"># running.</span>
            <span class="n">rsp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_response</span><span class="p">(</span>
                <span class="n">curl</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">header_buffer</span><span class="p">,</span> <span class="n">default_encoding</span><span class="p">,</span> <span class="n">discard_cookies</span>
            <span class="p">)</span>

            <span class="n">first_element</span> <span class="o">=</span> <span class="n">_peek_aio_queue</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">first_element</span><span class="p">,</span> <span class="n">RequestException</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">release_curl</span><span class="p">(</span><span class="n">curl</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">first_element</span>

            <span class="n">rsp</span><span class="o">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">req</span>
            <span class="n">rsp</span><span class="o">.</span><span class="n">astream_task</span> <span class="o">=</span> <span class="n">stream_task</span>
            <span class="n">rsp</span><span class="o">.</span><span class="n">quit_now</span> <span class="o">=</span> <span class="n">quit_now</span>
            <span class="n">rsp</span><span class="o">.</span><span class="n">queue</span> <span class="o">=</span> <span class="n">q</span>
            <span class="k">return</span> <span class="n">rsp</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">acurl</span><span class="o">.</span><span class="n">add_handle</span><span class="p">(</span><span class="n">curl</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">task</span>
            <span class="k">except</span> <span class="n">CurlError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">rsp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_response</span><span class="p">(</span>
                    <span class="n">curl</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">header_buffer</span><span class="p">,</span> <span class="n">default_encoding</span><span class="p">,</span> <span class="n">discard_cookies</span>
                <span class="p">)</span>
                <span class="n">rsp</span><span class="o">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">req</span>
                <span class="n">error</span> <span class="o">=</span> <span class="n">code2error</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                <span class="k">raise</span> <span class="n">error</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">e</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="n">rsp</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rsp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_response</span><span class="p">(</span>
                    <span class="n">curl</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">header_buffer</span><span class="p">,</span> <span class="n">default_encoding</span><span class="p">,</span> <span class="n">discard_cookies</span>
                <span class="p">)</span>
                <span class="n">rsp</span><span class="o">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">req</span>
                <span class="k">return</span> <span class="n">rsp</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">release_curl</span><span class="p">(</span><span class="n">curl</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">head</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Unpack</span><span class="p">[</span><span class="n">RequestParams</span><span class="p">]):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;HEAD&quot;</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Unpack</span><span class="p">[</span><span class="n">RequestParams</span><span class="p">]):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Unpack</span><span class="p">[</span><span class="n">RequestParams</span><span class="p">]):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;POST&quot;</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Unpack</span><span class="p">[</span><span class="n">RequestParams</span><span class="p">]):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;PUT&quot;</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">patch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Unpack</span><span class="p">[</span><span class="n">RequestParams</span><span class="p">]):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;PATCH&quot;</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Unpack</span><span class="p">[</span><span class="n">RequestParams</span><span class="p">]):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;DELETE&quot;</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">options</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Unpack</span><span class="p">[</span><span class="n">RequestParams</span><span class="p">]):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;OPTIONS&quot;</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">trace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Unpack</span><span class="p">[</span><span class="n">RequestParams</span><span class="p">]):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;TRACE&quot;</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Unpack</span><span class="p">[</span><span class="n">RequestParams</span><span class="p">]):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s2">&quot;QUERY&quot;</span><span class="p">,</span> <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Amir Nazary.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>